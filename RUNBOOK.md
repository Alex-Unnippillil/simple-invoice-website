# Backup Runbook

This runbook describes how PDFs generated by the application are synced from
Azure Blob Storage to an S3-compatible bucket and how the database is backed up.

## Overview
- **Script:** [`scripts/backup.sh`](scripts/backup.sh)
- **Schedule:** Daily at 02:00 UTC via `cron`
- **Artifacts:**
  - Invoice PDFs copied to `s3://$S3_BUCKET/pdfs`
  - Database dump or managed snapshot stored in `s3://$S3_BUCKET/db/`

## Prerequisites
- Azure CLI with access to the Blob container storing invoice PDFs.
- AWS CLI configured for the destination S3 bucket or Cloudflare R2 endpoint.
- PostgreSQL `pg_dump` installed if using logical dumps.

Required environment variables:

| Variable | Description |
|---|---|
| `AZURE_CONTAINER` | Blob container with generated PDFs |
| `AZURE_STORAGE_ACCOUNT` | Azure storage account name |
| `AZURE_STORAGE_KEY` or `AZURE_STORAGE_SAS_TOKEN` | Authentication for Azure |
| `S3_BUCKET` | Destination S3/R2 bucket |
| `S3_ENDPOINT` | (Optional) Endpoint URL for R2 or other S3-compatible storage |
| `DATABASE_URL` | Postgres connection string (used with `pg_dump`) |
| `RDS_DB_INSTANCE` | Identifier for managed snapshot (used if `pg_dump` unavailable) |

## Cron Setup
Install the following cron entry for the user that has access to the
credentials:

```
0 2 * * * /path/to/repo/scripts/backup.sh >> /var/log/invoice-backup.log 2>&1
```

## Running Manually
To trigger the backup manually, ensure the environment variables above are set
and execute:

```
./scripts/backup.sh
```

## Restore Procedure
1. **PDFs**: Retrieve desired files from `s3://$S3_BUCKET/pdfs` using `aws s3 cp`.
2. **Database**:
   - If `pg_dump` was used, download the dump from `s3://$S3_BUCKET/db/` and run
     `psql <dump-file.sql>`.
   - If a managed snapshot was created, restore according to your cloud
     provider's documentation (e.g., `aws rds restore-db-instance-from-db-snapshot`).

## Verification
After the job runs, verify that new PDFs and a database snapshot exist in the
bucket and that the log file contains no errors.
